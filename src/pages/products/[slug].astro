---
import Layout from '../../layouts/Layout.astro';
import fs from 'node:fs/promises';
import path from 'node:path';

interface ProductPageProps {
  title: string;
  description: string;
  image: string;
  affiliate_link: string;
  top_reviews?: {
    id: string;
    title: string;
    body: string;
    stars: number;
  }[];
}

export async function getStaticPaths() {
  const dir = path.resolve('./src/content/products');
  const files = await fs.readdir(dir);
  return files.map((file) => ({
    params: { slug: file.replace('.json', '') },
  }));
}

export async function getStaticProps({ params }) {
  const filePath = path.resolve(`./src/content/products/${params.slug}.json`);
  const raw = await fs.readFile(filePath, 'utf-8');
  const data = JSON.parse(raw);

  // ‚úÖ Keep the product small by only sending the first review
  const cleanedReviews = Array.isArray(data.top_reviews)
    ? data.top_reviews.slice(0, 1)
    : [];

  console.log('üß™ Top reviews trimmed to count:', cleanedReviews.length);

  return {
    props: {
      ...data,
      top_reviews: cleanedReviews,
    },
  };
}

const raw = Astro.props as ProductPageProps;
const props = {
  ...raw,
  top_reviews: raw.top_reviews ?? [],
};

console.log('üß™ Final merged props:', props);
---

<Layout>
  <main class="bg-page text-default min-h-screen py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-5xl mx-auto">
      <div class="flex flex-col lg:flex-row gap-8 items-start">
        <div class="w-full lg:w-1/2">
          <img src={props.image} alt={props.title} class="rounded-xl shadow-xl w-full" loading="lazy" />
        </div>

        <div class="w-full lg:w-1/2 space-y-4">
          <h1 class="text-4xl font-heading font-bold">{props.title}</h1>

          <div class="flex items-center text-muted text-sm">
            <div class="text-yellow-400 mr-2 text-lg">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
            <span>4.7 average rating ‚Ä¢ 14,230 reviews</span>
          </div>

          <p class="text-lg">{props.description}</p>

          <ul class="list-disc list-inside text-muted space-y-2">
            <li>Powerful 900-watt motor with cyclonic action</li>
            <li>Includes 2 to-go cups with lids</li>
            <li>BPA-free, dishwasher-safe components</li>
          </ul>

          <a
            href={props.affiliate_link}
            target="_blank"
            rel="nofollow noreferrer"
            class="btn btn-primary w-full text-lg"
          >
            üõí Buy on Amazon
          </a>

          <p class="text-sm text-muted text-center">
            #ad ‚Äî I may earn a small commission at no extra cost to you
          </p>
        </div>
      </div>

      {
        props.top_reviews.length > 0 && (
          <section class="mt-16">
            <h2 class="text-2xl font-heading font-semibold mb-6 border-b border-default pb-2">
              What Customers Are Saying
            </h2>
            <ul class="space-y-6">
              {props.top_reviews.map((review) => (
                <li class="rounded-xl border border-default p-5 bg-white dark:bg-dark/40">
                  <div class="flex items-center justify-between mb-2">
                    <h3 class="text-lg font-semibold">{review.title}</h3>
                    <div class="text-yellow-400 text-sm">{'‚≠ê'.repeat(review.stars || 0)}</div>
                  </div>
                  <p class="text-muted">{review.body}</p>
                </li>
              ))}
            </ul>
          </section>
        )
      }
    </div>
  </main>
</Layout>
